<html ng-app="app">
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="../bower_components/sega2/sega2.css" />
</head>
  
<style>
  body {margin:4em; font-family: Roboto, Helvetica, sans-serif}
  
  .clearfix:after {
       visibility: hidden;
       display: block;
       font-size: 0;
       content: " ";
       clear: both;
       height: 0;
       }
  .clearfix { display: inline-block; }
  /* start commented backslash hack \*/
  * html .clearfix { height: 1%; }
  .clearfix { display: block; }
  
  hr {
    height: 1px; 
    border: none;
    margin: 1em 0;
    border-top:solid #ccc 1px;
    background: none;
  }
  aside {
    float: left;
    width: 25%;
    min-width: 200px;
    margin-right: 3em;
  }
  aside ul {
    margin:0;
    padding:0;
  }
  aside li {list-style-type: none; padding: .3em 0}
  aside cite {
    display:block;
    padding:.5em 0;
  }
  
  .login label, .login input {display: block}
  .login input {margin-bottom:1em;}
  
  .method {margin-bottom: 1em;}
  
  .form {margin:0.5em 0 0 0}
  .form textarea {margin-bottom:0.5em; width:100%; border-color:lavender;}
  pre {margin:0}
  .json {padding: 1em; background:#ffffdd; font-size:80%}
  .params {margin-top:0.5em}
  .no-top-padding {padding-top:0}
  
  .elapsed {margin-left:1em; color:#777; font-size:80%}
  .result .json {background:#dcf6ff; border:solid 1px #bde0ec; margin-top:0.5em}
  .error .json {background:#fff2f2; border:solid 1px #f8d1d1; margin-top:0.5em; color: #cc0000;}
  
  h1 {margin: 1em 0 0.5em 0; font-size:150%}
  </style>
<body ng-controller="appCtrl">
  <main class="paper">
    <article ng-if="!authorized">

      <form class="login" onSubmit="auth.login()">
        <label>Пользователь</label>
        <input name="username" />
        <label>Пароль</label>
        <input name="password" type="password" />
        <input type="submit" class="-small" value="Отправить" />
      </form>
      <ul>
      </ul>
      
    </article>
    
    <span class="tap" ng-class="{'-active': expand}"><a ng-click="expand=!expand">Expand all</a></span> 
    <span class="tap" ng-class="{'-active': forms}"><a ng-click="forms=!forms">Show forms</a></span> 
    
    <article class="clearfix" ng-repeat="(model, vmodel) in apiSchema">
      <h1>{{model | uppercase}}</h1>
          <div class="method clearfix" ng-repeat="(method, vmethod) in vmodel.methods" ng-init="initMethod(model,method,vmethod)">
            <div>
              <a class="pseudo-link" ng-click="vmethod.expand = !vmethod.expand">{{vmethod.methodname}}</a>
            </div>
            
            <div class="more" ng-show="expand || vmethod.expand">
            <div class="form" ng-show="forms">
              <textarea ng-if="vmethod.params" style="height:6em" ng-model="vmethod.formatedParams"></textarea>
              <div>
            <input type="submit" class="-small -blue" value="Отправить" ng-click="apicall(vmethod.methodname,vmethod.formatedParams,vmethod)" /> 
              
              <span class="elapsed">
                <span ng-if="!vmethod._inprogress && vmethod._elapsed"><span ng-bind="vmethod._elapsed"></span> ms</span>
                <span ng-if="vmethod._inprogress"><i class="fa fa-spin fa-circle-o-notch"></i></span>
              </span>
              </div>
              <div ng-if="vmethod._result && !vmethod._error" class="result">
                <pre class="json">{{vmethod._result}}</pre>
              </div>  
              <div ng-if="vmethod._error" class="error">
                <pre class="json">Error: {{vmethod._error}}</pre>
              </div>  
            </div>
              

            <div class="params">
              <pre class="request json" ng-if="vmethod.params">Request:
{{vmethod.params | JSON}}
              </pre>
              <pre class="request json" ng-if="vmethod.response" ng-class="{'no-top-padding': vmethod.params}">Response:
{{vmethod.response | JSON}}
              </pre>

            </div>
                        
          </div>  
    </article>  

    
  </main>
</body>
  
  <script src="../apiSchema.js">;</script>
  <script src="../bower_components/angularjs/angular.js"></script>
  <script>

    var app = angular.module("app",[]);

    app.controller("appCtrl", function($scope, $filter, $http, api) {
      
      $scope.apiSchema = apiSchema;
      $scope.api = api('ws://localhost:3001');
      $scope.autorized = false;
      $scope.forms = true;
      $scope.expand = true;
      
      $scope.initMethod = function(model, method, vmethod) {
        vmethod.methodname = model + '.' + method;
        if (vmethod.params) {
          vmethod.formatedParams = $filter('formatedParams')(vmethod.params);
        } else {
          vmethod.formatedParams = null;
        }
      };
      
      $scope.apicall = function(method, params, vmethod) {
        
        vmethod._inprogress = true;
        
        try {
          var p = (params) ? JSON.parse(params) : null;
          var start = new Date();
          $scope.api(method, p, function(err, result) {
            $scope.$apply(function() {
              var elapsed = new Date() - start;
              vmethod._elapsed = elapsed;
              vmethod._inprogress = false;
              
              vmethod._result = (err && typeof result === 'object') ? JSON.stringify(result, null, 4) : result;
              vmethod._error = (err && typeof err === 'object') ? JSON.stringify(err, null, 4) : err;
            });
          });
        } catch(e) {
          console.error(e);
        }
      };
      
      $scope.api('mirror', ['a param', 'another param']);
      
    });
    

    app.filter('formatedParams', function() {
      return function(o) {
        var object = angular.copy(o);
        for(var key in object) {
          if (object[key] = "number") object[key] = '';
        }
        return JSON.stringify(object, null, 4);
    }});

    app.filter('JSON', function() {
      return function(o) {
        return JSON.stringify(o, null, 4);
    }});
    
 
  </script>
  <script src="../lib/api.js">;</script>
  
  
</html>